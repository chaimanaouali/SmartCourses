{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link id="pagestyle" href="{% static 'css/argon-dashboard.css' %}" rel="stylesheet" />
  <title>Workshop Detail</title>
</head>
<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-dark position-absolute w-100"></div>
  <main class="main-content position-relative border-radius-lg">
    <div class="container-fluid py-4">
      <div class="card">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Workshop Detail</h6>
          <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">Back to Dashboard</a>
        </div>
        <div class="card-body">
          {% if workshop.cover_image %}
          <img src="{{ workshop.cover_image.url }}" alt="Cover" class="img-fluid rounded mb-3" style="max-height:400px; width:100%; object-fit:cover;">
          {% endif %}
          <h5 class="mb-1">{{ workshop.title }}</h5>
          <p class="text-sm text-muted">Course: {{ workshop.course.title }}</p>
          {% if workshop.scheduled_at %}
          <p class="text-sm text-muted">Scheduled: {{ workshop.scheduled_at|date:"M d, Y H:i" }}</p>
          {% endif %}
          {% if workshop.location %}
          <p class="text-sm text-muted">Location: {{ workshop.location }}</p>
          {% endif %}
          <p>{{ workshop.description }}</p>
          
          {% if user.is_authenticated %}
          <div class="card mb-3">
            <div class="card-header pb-1 pt-2">
              <h6 class="mb-0">AI Assistant</h6>
              <small class="text-muted">Powered by Groq â€“ asks from this workshop's course context</small>
            </div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-8">
                  <label class="form-label">Ask a question</label>
                  <textarea id="wsAssistantQuestion" class="form-control" rows="3" placeholder="Explain topic X, give examples, outline steps..."></textarea>
                  <button id="wsAskBtn" class="btn btn-primary btn-sm mt-2">Ask Assistant</button>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Quick tools</label>
                  <div>
                    <button id="wsSummaryBtn" class="btn btn-dark btn-sm w-100 mb-2">Generate Course Summary</button>
                    <a href="{% url 'course_detail' workshop.course.id %}" class="btn btn-outline-secondary btn-sm w-100">Open Course</a>
                  </div>
                </div>
              </div>
              <div id="wsAssistantAnswer" class="mt-3" style="display:none;"></div>
              <div id="wsSummaryResult" class="mt-3 small text-muted" style="display:none;"></div>
            </div>
          </div>
          {% endif %}

          <div class="d-flex gap-2">
            {% if not hide_crud and user.is_authenticated and user.id == workshop.created_by.id %}
            <a href="{% url 'workshop_update' workshop.id %}" class="btn btn-outline-secondary btn-sm">Edit</a>
            <a href="{% url 'workshop_delete' workshop.id %}" class="btn btn-outline-danger btn-sm">Delete</a>
            {% endif %}
            <a href="{% url 'workshop_list' %}" class="btn btn-outline-primary btn-sm">Back</a>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  {% if user.is_authenticated %}
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const courseId = "{{ workshop.course.id }}";
    const wsAskBtn = document.getElementById('wsAskBtn');
    const wsAssistantQuestion = document.getElementById('wsAssistantQuestion');
    const wsAssistantAnswer = document.getElementById('wsAssistantAnswer');
    const wsSummaryBtn = document.getElementById('wsSummaryBtn');
    const wsSummaryResult = document.getElementById('wsSummaryResult');

    if (wsAskBtn) {
      wsAskBtn.addEventListener('click', async () => {
        const q = (wsAssistantQuestion.value || '').trim();
        if (!q) { wsAssistantAnswer.textContent = 'Please enter a question.'; wsAssistantAnswer.style.display = 'block'; return; }
        wsAskBtn.disabled = true; wsAskBtn.textContent = 'Thinking...';
        wsAssistantAnswer.style.display = 'none';
        try {
          const res = await fetch(`/api/course/${courseId}/explain/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ question: q, from: 'workshop' })
          });
          const data = await res.json();
          wsAssistantAnswer.innerHTML = (data.answer || data.error || 'No answer produced.').replaceAll('\n', '<br>');
          wsAssistantAnswer.style.display = 'block';
        } catch (e) {
          wsAssistantAnswer.textContent = 'Error asking assistant.';
          wsAssistantAnswer.style.display = 'block';
        } finally {
          wsAskBtn.disabled = false; wsAskBtn.textContent = 'Ask Assistant';
        }
      });
    }

    if (wsSummaryBtn) {
      wsSummaryBtn.addEventListener('click', async () => {
        wsSummaryBtn.disabled = true; wsSummaryBtn.textContent = 'Generating...';
        wsSummaryResult.style.display = 'none';
        try {
          const res = await fetch(`/api/course/${courseId}/summary/?from=workshop`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
          });
          const data = await res.json();
          wsSummaryResult.textContent = data.summary || data.error || 'No summary produced.';
          wsSummaryResult.style.display = 'block';
        } catch (e) {
          wsSummaryResult.textContent = 'Error generating summary.';
          wsSummaryResult.style.display = 'block';
        } finally {
          wsSummaryBtn.disabled = false; wsSummaryBtn.textContent = 'Generate Course Summary';
        }
      });
    }
  </script>
  {% endif %}
</body>
</html>


