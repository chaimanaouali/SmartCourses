{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{% static 'img/apple-icon.png' %}">
  <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
  <title>Face Recognition Login - Educational Hub</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{% static 'css/nucleo-icons.css' %}" rel="stylesheet" />
  <link href="{% static 'css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="{% static 'css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'css/argon-dashboard.css' %}?v=2.1.0" rel="stylesheet" />
  <style>
    #video {
      width: 100%;
      max-width: 640px;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    #canvas {
      display: none;
    }
    
    .camera-container {
      position: relative;
      text-align: center;
    }
    
    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 400px;
      border: 3px solid #5e72e4;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      pointer-events: none;
    }
    
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
    }
    
    .status-success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .status-info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>

<body class="">
  <main class="main-content mt-0">
    <section>
      <div class="page-header min-vh-100">
        <div class="container">
          <div class="row">
            <div class="col-xl-6 col-lg-7 col-md-9 mx-auto">
              <div class="card z-index-0">
                <div class="card-header text-center pt-4 pb-1">
                  <h4 class="font-weight-bolder">AI-Powered Face Recognition Login</h4>
                  <p class="mb-0">Position your face in the camera and click "Login with Face"</p>
                </div>
                <div class="card-body">
                  <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="camera-overlay"></div>
                    <canvas id="canvas"></canvas>
                  </div>
                  
                  <div id="statusMessage" class="status-message status-info" style="display: none;">
                    Initializing camera...
                  </div>
                  
                  <div class="text-center mt-4">
                    <button id="loginBtn" class="btn btn-lg btn-primary btn-lg w-100 mt-2 mb-0" onclick="captureAndLogin()">
                      <i class="fas fa-camera me-2"></i> Login with Face
                    </button>
                    <button id="retryBtn" class="btn btn-lg btn-outline-secondary btn-lg w-100 mt-2 mb-0" onclick="retryCamera()" style="display: none;">
                      <i class="fas fa-redo me-2"></i> Retry
                    </button>
                  </div>
                  
                  <p class="text-sm mt-3 mb-0 text-center">
                    Don't have face recognition set up? 
                    <a href="{% url 'signin' %}" class="text-dark font-weight-bolder">Sign in with password</a>
                  </p>
                  <p class="text-sm mt-1 mb-0 text-center">
                    New user? 
                    <a href="{% url 'signup' %}" class="text-dark font-weight-bolder">Create an account</a>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!--   Core JS Files   -->
  <script src="{% static 'js/core/popper.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/plugins/perfect-scrollbar.min.js' %}"></script>
  <script src="{% static 'js/plugins/smooth-scrollbar.min.js' %}"></script>

  <script>
    let videoStream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusMessage = document.getElementById('statusMessage');
    const loginBtn = document.getElementById('loginBtn');
    const retryBtn = document.getElementById('retryBtn');

    // Initialize camera
    async function initCamera() {
      try {
        showStatus('Requesting camera access...', 'info');
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          } 
        });
        video.srcObject = videoStream;
        showStatus('Camera ready! Position your face and click "Login with Face"', 'info');
        loginBtn.disabled = false;
      } catch (error) {
        console.error('Error accessing camera:', error);
        showStatus('Unable to access camera. Please check permissions.', 'error');
        retryBtn.style.display = 'block';
        loginBtn.disabled = true;
      }
    }

    // Capture image and perform face recognition login
    async function captureAndLogin() {
      loginBtn.disabled = true;
      showStatus('Capturing image and recognizing face...', 'info');

      // Set canvas size to match video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Draw current video frame to canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convert canvas to blob
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('image', blob, 'face.jpg');

        try {
          const response = await fetch('/api/face-login/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
          });

          const data = await response.json();

          if (response.ok && data.success) {
            showStatus(`Welcome, ${data.user}! Redirecting to dashboard...`, 'success');
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          } else {
            showStatus(data.message || 'Face not recognized. Please try again.', 'error');
            loginBtn.disabled = false;
            retryBtn.style.display = 'block';
          }
        } catch (error) {
          console.error('Error during login:', error);
          showStatus('An error occurred during login. Please try again.', 'error');
          loginBtn.disabled = false;
          retryBtn.style.display = 'block';
        }
      }, 'image/jpeg', 0.95);
    }

    // Retry camera initialization
    function retryCamera() {
      retryBtn.style.display = 'none';
      loginBtn.disabled = false;
      initCamera();
    }

    // Show status message
    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message status-' + type;
      statusMessage.style.display = 'block';
    }

    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Clean up camera when page is closed
    window.addEventListener('beforeunload', () => {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
    });

    // Initialize camera on page load
    initCamera();
  </script>
</body>

</html>
