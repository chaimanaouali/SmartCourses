{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{% static 'img/apple-icon.png' %}">
  <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
  <title>Sign In - Educational Hub</title>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/argon-dashboard-pro/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/argon-dashboard-pro/assets/css/nucleo-svg.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link id="pagestyle" href="{% static 'css/argon-dashboard.css' %}?v=2.1.0" rel="stylesheet" />
</head>

<body class="bg-gray-100">
  <div class="min-height-300 bg-dark position-absolute w-100"></div>
  
  <main class="main-content position-relative border-radius-lg">
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-white" href="{% url 'home' %}">Pages</a></li>
            <li class="breadcrumb-item text-sm text-white active" aria-current="page">Sign In</li>
          </ol>
          <h6 class="font-weight-bolder text-white mb-0">Sign In</h6>
        </nav>
      </div>
    </nav>
    
    <div class="container-fluid py-4">
      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex align-items-center">
                <p class="mb-0">Sign In</p>
              </div>
            </div>
            <div class="card-body">
              <form method="post">
                {% csrf_token %}
                <div class="form-group">
                  <label for="username" class="form-control-label">Username</label>
                  <input class="form-control" type="text" name="username" id="username" required>
                </div>
                <div class="form-group">
                  <label for="password" class="form-control-label">Password</label>
                  <input class="form-control" type="password" name="password" id="password" required>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <a href="{% url 'signup' %}" class="text-sm">Don't have an account? Sign Up</a>
                  <button type="submit" class="btn btn-primary">Sign In</button>
                </div>
              </form>
              
              <!-- Face Recognition Login -->
              <hr class="horizontal dark">
              <div class="text-center">
                <h6 class="text-sm font-weight-bold">Or sign in with face recognition</h6>
                <div class="mt-3">
                  <button id="faceLoginBtn" class="btn btn-outline-primary">
                    <i class="ni ni-camera-compact me-2"></i>Face Recognition Login
                  </button>
                </div>
                <input type="file" id="faceImageInput" accept="image/*" style="display: none;">
                <div id="faceLoginResult" class="mt-3" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script src="{% static 'js/core/popper.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/argon-dashboard.min.js' %}?v=2.1.0"></script>
  
  <script>
    document.getElementById('faceLoginBtn').addEventListener('click', function() {
      document.getElementById('faceImageInput').click();
    });
    
    document.getElementById('faceImageInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch('/api/face-login/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        const resultDiv = document.getElementById('faceLoginResult');
        
        if (response.ok && data.success) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <h6>Face Recognition Successful!</h6>
              <p>Welcome back, ${data.user}!</p>
            </div>
          `;
          resultDiv.style.display = 'block';
          
          // Redirect to dashboard after successful login
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <h6>Face Recognition Failed</h6>
              <p>${data.error || 'Face not recognized. Please try again or use regular login.'}</p>
            </div>
          `;
          resultDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('faceLoginResult').innerHTML = `
          <div class="alert alert-danger">
            <h6>Error</h6>
            <p>An error occurred during face recognition. Please try again.</p>
          </div>
        `;
        document.getElementById('faceLoginResult').style.display = 'block';
      }
    });
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>

</html>
